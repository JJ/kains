#!/usr/bin/env perl6

use v6;
use NativeCall;

sub MAIN() {
	sub check-native-error(int $status) {
		my $caller_name := callframe(1).my.<&?ROUTINE>.name; # caller() NYI

		my $errno := cglobal('libc.so.6', 'errno', int32);
		sub strerror(int --> Str) is native { * }

		$status >= 0 or die "Error calling native function: "
				  ~ "$caller_name: { strerror($errno) }"
	}

	sub unshare(int $flags)	{
		sub unshare-native(int --> int) is native is symbol('unshare') { * }

		check-native-error(unshare-native($flags));
	}

	constant CLONE_NEWNS	:= 0x00020000;
	constant CLONE_NEWUSER	:= 0x10000000;

	unshare(CLONE_NEWUSER +| CLONE_NEWNS);
}
