#!/usr/bin/env perl6

use v6;
use Glibc::Linux :unshare, :mount, :chroot;

my $rootfs	::= '/usr/local/cedric/rootfs/stage3-amd64-hardened+nomultilib-20141120';
my @bindings	::= < /dev /sys /proc /tmp >;

unshare(CLONE_NEWUSER +| CLONE_NEWNS);

for @bindings {
	mount($_, "$rootfs/$_", '', MS_PRIVATE +| MS_BIND +| MS_REC, '');
}

chroot($rootfs);

chdir('/');

run('/bin/bash');

CATCH {
	use Glibc::Errno;

	when X::Errno {
		say "FATAL: ", .message();

		if .errno == EPERM {
			say "INFO: It seems your system doesn't support user namespaces; "
			  ~ "you might want to try PRoot instead: http://proot.me";
		}
	}
}
